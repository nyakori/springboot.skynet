<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kaos.his.mapper.personnel.OutpatientMapper">
    <!-- 实体映射表 -->
    <resultMap id="map" extends="com.kaos.his.mapper.personnel.DeptpatientMapper.map" type="com.kaos.his.entity.personnel.Outpatient">
        <id column="CLINIC_CODE" jdbcType="VARCHAR" property="clinicCode"/>
        <result column="STATE" jdbcType="VARCHAR" property="state"/>
    </resultMap>

    <!-- 接口1 -->
    <select id="QueryOutpatient" resultMap="map">
        SELECT
        <include refid="allItem"/>
        FROM
            FIN_OPR_REGISTER T1
            LEFT JOIN COM_PATIENTINFO T2 ON T2.CARD_NO = T1.CARD_NO AND T2.IS_VALID = '1'
        <where>
            <if test="clinicCode!=null">
                AND T1.CLINIC_CODE = #{clinicCode}
            </if>
        </where>
    </select>

    <!-- 接口2 -->
    <select id="QueryOutpatients" resultMap="map">
        SELECT
        <include refid="allItem"/>
        FROM
            FIN_OPR_REGISTER T1
            LEFT JOIN COM_PATIENTINFO T2 ON T2.CARD_NO = T1.CARD_NO AND T2.IS_VALID = '1'
        <where>
            <if test="clinicCode!=null">
                AND T1.CARD_NO = #{cardNo}
            </if>
        </where>
        ORDER BY
            T1.OPER_DATE ASC
    </select>

    <!-- 所有字段 -->
    <sql id="allItem">
        T1.CLINIC_CODE AS CLINIC_CODE,
        T1.IN_STATE AS STATE,
        <include refid="deptpatientItem"/>
    </sql>

    <!-- baseItem -->
    <sql id="deptpatientItem">
        <include refid="OPER_employeeItem"/>
        T1.OPER_DATE AS OPER_DATE,
        <include refid="DEPT_departmentItem"/>
        <include refid="patientItem"/>
    </sql>

    <!-- operEmployee -->
    <sql id="OPER_employeeItem">
        T1.OPER_CODE AS OPER_CODE,
    </sql>

    <!-- dept -->
    <sql id="DEPT_departmentItem">
        T1.DEPT_CODE AS DEPT_CODE,
    </sql>

    <!-- baseItem -->
    <sql id="patientItem">
        T2.CARD_NO  AS CARD_NO,
        T2.GCPOUTPATIENT AS GCPOUTPATIENT,
        <include refid="citizenItem"/>
    </sql>

    <!-- baseItem -->
    <sql id="citizenItem">
        T2.NAME AS NAME,
        T2.SEX_CODE AS SEX,
        T2.BIRTHDAY AS BIRTHDAY,
        T2.IDENNO AS IDENTITY_NO,
        NVL(WORK_TEL, NVL(HOME_TEL, LINKMAN_TEL)) AS PHONE_NO,
        T2.EMAIL AS EMAIL
    </sql>
</mapper>